<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="icon" type="image/png" href="https://diviengine.com/wp-content/uploads/2023/01/ChatGPT-Logooptimized-610x610.png" />
	<title>Chatbot Demo v0.5</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.7/css/all.css">
	<script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script>
	<script src="https://cdn.staticfile.org/markdown-it/13.0.1/markdown-it.min.js"></script>
	<style>

		.chat-box {
		  height: calc(100vh - 238px); /* subtract the space occupied by the navbar and footer */
		  overflow-y: scroll;
		}

		@media only screen and (max-width: 480px) {
		  .chat-box {
			height: calc(100vh - 300px); /* adjust the height value as per your requirement */
			overflow-y: scroll;
		  }
		}

		.message {
			margin-bottom: 10px;
			padding: 10px;
			padding-bottom: 0;
			border-radius: 10px;
			display: inline-block;
			max-width: 85%;
			word-wrap: break-word;
			white-space: normal;
		}

		.left-side {
			background-color: lightgray;
			float: left;
		}

		.right-side {
			background-color: lightgreen;
			float: right;
		}
		.popup {
			position: fixed;
			bottom: 20vh;
			left: 50%;
			transform: translateX(-50%);
			background-color: rgba(0, 0, 0, 0.6);
			color: white;
			border-radius: 5px;
			padding: 10px 20px;
			font-size: 16px;
			display: none;
		}

		/* Toggle Switch */

		.switch {
		  position: relative;
		  display: inline-block;
		  width: 60px;
		  height: 34px;
		}
		.switch input {
		  opacity: 0;
		  width: 0;
		  height: 0;
		}
		.slider {
		  position: absolute;
		  cursor: pointer;
		  top: 0;
		  left: 0;
		  right: 0;
		  bottom: 0;
		  background-color: #ccc;
		  transition: .4s;
		}
		.slider:before {
		  position: absolute;
		  content: "";
		  height: 26px;
		  width: 26px;
		  left: 4px;
		  bottom: 4px;
		  background-color: white;
		  transition: .4s;
		}
		input:checked + .slider {
		  background-color: #555261;
		}
		input:checked + .slider:before {
		  transform: translateX(26px);
		}
		.slider.round {
		  border-radius: 34px;
		}
		.slider.round:before {
		  border-radius: 50%;
		}


		/* Dark Theme */
		.dark-mode .dark-theme {
		  background-color: #333;
		  color: #fff;
		}

		.dark-mode .nav{
		  background-color: #333;
		  color: #fff;
		}

		.dark-mode .dark-text {
		  color: #fff;
		}

		.dark-mode .card {
		  background-color: #333;
		  color: #fff;
		}

		.dark-mode .popup {
		  background-color: #fff;
		  color: #333;
		}

		.dark-mode .fa-clipboard {
		  color: #212529;
		  background-color: #7cc;
		  border-color: #5bc2c2
		}

		.dark-mode .fa-clipboard:hover {
		  color: #212529;
		  background-color: #52bebe;
		  border-color: #8ad3d3
		}

		.bg-skyblue{
		background-color: #e3f2fd;
		}

</style>
</head>
<body class=" bg-secondary">
	<nav class="navbar navbar-expand-lg navbar-light sticky-top top-0 shadow py-0 bg-skyblue dark-theme">
		<a class="navbar-brand logo pl-4 dark-text" href="#">
			 <h3>Chat Demo</h3>
		</a>
		<a href="https://github.com/phuongnam0907" target="blank" class="github-corner" aria-label="View source on GitHub">
		  <svg width="50" height="50" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true">
			<path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
			<path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
			<path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
		  </svg>
		</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse " id="navbarNav">
            <ul class="navbar-nav ml-auto mt-2 mt-lg-0 mb-1 ">
                 <li class="nav-item">
					<div class="d-flex align-items-center">
                        <h3>Dark mode </h3>
						<label class="switch mb-0 pl-5">
							<input type="checkbox" id="darkModeToggle" >
							<span class="slider round"></span>
						</label>
					</div>
				</li>
            </ul>
        </div>
	</nav>
	<div class="container-fluid">
		<div class="row ">
			<div class="col-md-12 mb-3">
				<div class="card mt-3">
					<div class="card-header row">
						<div class="col-6 ">
							<h3>Chat Box</h3>
						</div>
						<div class="col-6 offset-md-3 col-md-3 text-right">
							<a  type="button" onclick="window.print()" class="btn  btn-outline-info">Print</a>
							<a  type="button" class="btn btn-outline-danger " onclick="clearContent()">Clear</a>
						</div>
					</div>
					<div class="card-body chat-box rounded p1" id="chatbox"><span id="copy-popup" class="popup">Copied!</span></div>
					<div class="card-footer">
						<div class="form-group row">
							<div class="col-md-10 mb-1">
								<textarea id="userInput" rows="1" class="form-control dark-theme" placeholder="Nhập tin nhắn tại đây ..." ></textarea>
							</div>
							<div class="col-md-2">
								<input id="sendButton" type="button" value="Gửi" class=" form-control btn btn-success btn-block " />
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
<script>
const toggleSwitch = document.querySelector('#darkModeToggle');
toggleSwitch.addEventListener('change', switchTheme);

function switchTheme(event) {
  if (event.target.checked) {
    document.body.classList.add('dark-mode');
	document.nav.classList.remove('bg-skyblue');
  } else {
    document.body.classList.remove('dark-mode');
  }
}
</script>
<script>
function clearContent(){
    document.getElementById('chatbox').innerHTML = '';
}

const url = new URL(window.location.href);
const key = url.searchParams.get('key');
const chatbox = $("#chatbox");
const userInput = $("#userInput");
const sendButton = $("#sendButton");
const _date = new Date();

var ObjContext = {
	action: "",
	category: "",
	phone_number: "",
	user_id: "",
	user_name: "",
	address: "",
	device_id: "",
	index_value: "",
	month: "",
	year: "",
}
function clearObjContext(){
	return ObjContext = {
		action: "",
		category: "",
		phone_number: "",
		user_id: "",
		user_name: "",
		address: "",
		device_id: "",
		index_value: "",
		month: "",
		year: "",
	}
}

let messages = "";
let _action = "";
let _category = "";
let _phone_number = "";
let _user_id = "";
let _user_name = "";
let _address = "";
let _month = "";
let _year = "";
let _device_id = "";
let _index_value = "";

const ActionStatus = {
	idle: 0,
	greeting:1,
	reflect_water_quality:2,
	reflect_water_supply: 3,
	request_watch_repair: 4,
	request_pipe_repair: 5,
	request_IndexWatch_check_explain: 6,
	request_valve_repair: 7,
	request_area_refund: 8,
	instruction_payment_methods: 9,
	request_invoices: 10,
	instruction_IndexWater_report: 11,
	instruction_IndexWater_input:12,
	explain_bill_period: 13,
	request_IndexWater_date: 14,
	explain_temporary_calculate: 15,
	research_water_price: 16,
	explain_business_water_price: 17,
	research_water_tax: 18,
	research_service_drainage: 19,
	research_environmental_fee: 20,
	request_instruction_NewWatch_install: 21,
	explain_NewWatch_install: 22,
	explain_NewWatch_install_fee: 23,
	change_information_contract: 24,
	provide_customer_information: 25,
	forget_personal_information:26,
	request_watch_move_move_lift_secure:27,
	discuss_information:28,
	
}
const InformationStatus = {
	idle: 0,
	info_reflect: 1,
	done_info_reflect : 2,
	info_request_watch_repair:3,
	done_info_request_watch_repair:4,
	info_request_pipe_repair:5,
	done_info_request_pipe_repair:6,
	info_request_IndexWatch_check_explain:7,
	done_info_request_IndexWatch_check_explain:8,
	info_request_valve_repair:9,
	done_info_request_valve_repair:10,
	info_request_area_refund:11,
	done_info_request_area_refund:12,
	info_request_invoices:13,
	info_instruction_IndexWater_report:14,
	done_info_instruction_IndexWater_report_input:15,
	info_request_instruction_NewWatch_install:16,
	info_change_information_contract:17,
	info_request_IndexWater_date:18,
	info_request_watch_move_move_lift_secure:19,
	done_info_request_watch_move_move_lift_secure:20,
	done_info_change_information_contract:21,
}


const ForgetInformationStatus = {
	info_forget_user_id:0,
	info_forget_user_name_address:1,
	info_forget_watch_id:2,
}
let _InfoStatus = InformationStatus.idle;
let _ForgetStatus = ForgetInformationStatus.info_forget_user_id;

sendButton.on("click", () => {
    const message = userInput.val();
    if (message) {
        messages = message;
		const displaytext = window.markdownit().render(message);
		let userMessageHtml = '<pre><div class="message right-side "  >' + displaytext + '</div></pre>';
		chatbox.append(userMessageHtml);
		chatbox.animate({ scrollTop: 20000000 }, "slow");
        userInput.val("");
        sendButton.val("Generating Response...");
		sendButton.prop("disabled", true);
        fetchMessages();
    }
});

userInput.on("keydown", (event) => {
    if (event.keyCode === 13 && !event.ctrlKey && !event.shiftKey) {
        event.preventDefault();
        sendButton.click();
    } else if (event.keyCode === 13 && (event.ctrlKey || event.shiftKey)) {
        event.preventDefault();
        const cursorPosition = userInput.prop("selectionStart");
        const currentValue = userInput.val();

        userInput.val(
            currentValue.slice(0, cursorPosition) +
            "\n" +
            currentValue.slice(cursorPosition)
        );
        userInput.prop("selectionStart", cursorPosition + 1);

        userInput.prop("selectionEnd", cursorPosition + 1);
    }
});
function isValidCustomerID(customerID) {
	// user id with 7 or 8 items with 1 character or not
	let makhachhang =  (/^[0-9]*[a-zA-Z]?[0-9]*$/.test(customerID) && (customerID.length === 7 || customerID.length === 8))? ("mã khách hàng: " + customerID) : false;
	return makhachhang;
}
function isValidPhoneNumber(phoneNumber) {
	// check phone number with 10 number with +84 == 0 follow VN region
	let sodienthoai = (/^(\+?84|\d)\d{9}$/.test(phoneNumber) || /^0\d{9}$/.test(phoneNumber))? ("số điện thoại: " + phoneNumber) : false;
	return sodienthoai;
}
function isValidCustomerName(customerName) {
	// user name with characters without number
	let tenkhachhang = (/^[^0-9]+$/.test(customerName))? ("tên khách hàng: " + customerName) : false;
	return tenkhachhang;
}
function isValidAddress(address) {
	// address with characters and numbers
	let diachi = (/[A-Za-z].*\d|\d.*[A-Za-z]/.test(address))? ("địa chỉ: " + address) : false;
	return diachi;
}
function isValidIndexWater(index_value) {
	// check index value with 3 numbers
	let chisonuoc = (/^\d{3}$/.test(index_value))? ("chỉ số nước: " + index_value) : false;
	return chisonuoc;
}
function isValidWatchID(watch_id) {
  // check watch id with 5 item without space and symbol
   let madongho = (/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z0-9]{5}$/.test(watch_id))? ("mã đồng hồ: "+watch_id) : false;
   return madongho;
}
function validateAndExtractInfo(inputString, _InfoStatus) {
	// split string
	const parts = inputString.split(',');
	// handle with having space
	const processedParts = parts.map(part => part.trim());

	let temp_customerID = "";
	let temp_customerName = "";
	let temp_phoneNumber = "";
	let temp_address = "";
	let temp_index_water = "";
	let temp_device_id = "";
    // Duyệt qua từng phần và xác định loại thông tin
	for (const part of processedParts) {
		if(isValidCustomerID(part)){
			temp_customerID = part;
			//console.log(temp_customerID);
		}
		else if (isValidPhoneNumber(part)) {
			temp_phoneNumber = part;
			//console.log(temp_phoneNumber);
		} 
		else if (isValidCustomerName(part)) {
			temp_customerName = part;
			//console.log(temp_customerName);
		} 
		else if(isValidIndexWater(part)){
			temp_index_water = part;
			//console.log(temp_index_water);
		}
		else if(isValidWatchID(part)) {
			temp_device_id = part;
			//console.log(temp_device_id);
		}
		else if (isValidAddress(part)) {
			temp_address = part;
			console.log(temp_address)
		}
		
  	}
  	// check value
  	const isValidInfo = {
		customerID: temp_customerID,
		phoneNumber: temp_phoneNumber,
		customerName: temp_customerName,
		index_water: temp_index_water,
		device_id: temp_device_id,
		address: temp_address
  	};
	if(_InfoStatus == InformationStatus.info_request_instruction_NewWatch_install){
		if (isValidInfo.customerName  && isValidInfo.phoneNumber  && isValidInfo.address) {
    		return isValidInfo;
    	}
		else {
			return false;
		}
	}
	else if(_InfoStatus == InformationStatus.info_change_information_contract){
		if ( isValidInfo.customerID || isValidInfo.address || (isValidInfo.customerID && isValidInfo.address)) {
			
    		return isValidInfo;
    	}
		else {
			return false;
		}
	}
	
}



function checkDB_CustomerID(_CustomerID, myList){
	return myList.includes(_CustomerID, myList);
}
const myList = ["1984500","1608984", "026B543", "188B083", "6829951", "1236746", "0238303", "9039930", "9039933", "6667739", 
				"6386514", "6929287", "6680312", "1839408", "188A503", "188A346", "6185089", "026B287", "9079710", "6940625", 
				"1905237", "1869715", "4260124", "6869143", "6185068", "6129734", "6549250", "6809579", "9030058", "6720282", 
				"8047390", "8120233", "8046838", "8046839", "9030008", "8120232", "8086969", "8039729", "8054262", "9040001", 
				"8046847", "9060007", "9060029", "8027264", "9060001", "9060019", "9060027", "9070592", "9020015", "9086181", "8221905"];

var result = "";
var _PrevActionStatus = ActionStatus.idle;
var ask_more = 0;

function clearPreviousAction(){
	_PrevActionStatus = ActionStatus.idle;
	ask_more = 0;
}

function clearForgetStatus(){
	_ForgetStatus = ActionStatus.idle;
}
function getCheckCustomer(_user_id){
	result = "";
	_month = String(_date.getMonth() + 1);
	_year = String(_date.getFullYear());
	var water_info = {
		url: "http://lpnserver.net:51087/bwaco?id=" + _user_id + "&m=" + _month + "&y=" + _year,
		method: "GET",
		timeout: 5000,
		async: false
	}
	$.ajax(water_info).done(function(res) {
		let len = res.length;
		res.forEach(element => {
			result += "Vâng, "+"mã khách hàng của nhà mình là: " + element["maKhachHang"] +", họ tên đồng hồ nước là: " + element["tenKhachHang"] + ", địa chỉ là: ....\n\n";
		});
	});
}
function fetchMessages() {
	if(_InfoStatus == InformationStatus.info_reflect || _InfoStatus == InformationStatus.info_request_watch_repair || 
	   _InfoStatus == InformationStatus.info_request_pipe_repair || _InfoStatus == InformationStatus.info_request_IndexWatch_check_explain ||
	   _InfoStatus == InformationStatus.info_request_valve_repair || _InfoStatus == InformationStatus.info_request_area_refund ||
	   _InfoStatus == InformationStatus.info_request_invoices || _InfoStatus == InformationStatus.info_instruction_IndexWater_report ||
	   _InfoStatus == InformationStatus.info_request_IndexWater_date ||  _InfoStatus == InformationStatus.info_request_watch_move_move_lift_secure){
		if(isValidCustomerID(messages) != false){
			messages = isValidCustomerID(messages);
		}
		if(_PrevActionStatus == ActionStatus.provide_customer_information){
			if(isValidPhoneNumber(messages) != false){
				messages = isValidPhoneNumber(messages);
				ask_more = 1;
			}
		}
	}
	else if(_InfoStatus == InformationStatus.done_info_reflect || _InfoStatus == InformationStatus.done_info_request_watch_repair || 
	   _InfoStatus == InformationStatus.done_info_request_pipe_repair || _InfoStatus == InformationStatus.done_info_request_IndexWatch_check_explain ||
	   _InfoStatus == InformationStatus.done_info_request_valve_repair || _InfoStatus == InformationStatus.done_info_request_area_refund ||
	   _InfoStatus == InformationStatus.done_info_request_invoices || _InfoStatus == InformationStatus.done_info_instruction_IndexWater_report ||
	   _InfoStatus == InformationStatus.done_info_request_IndexWater_date || _InfoStatus == InformationStatus.done_info_change_information_contract){
		if(isValidPhoneNumber(messages) != false){
			messages = isValidPhoneNumber(messages);
		}
	}
	else if(_InfoStatus == InformationStatus.info_request_instruction_NewWatch_install){
		let validInfo = validateAndExtractInfo(messages, _InfoStatus);
		if (validInfo != false){
			validInfo = isValidCustomerName(validInfo.customerName) + ", " + isValidPhoneNumber(validInfo.phoneNumber) + ", " + isValidAddress(validInfo.address);
			messages = validInfo;
		}
	}
	else if(_InfoStatus == InformationStatus.done_info_instruction_IndexWater_report_input){
		if(isValidIndexWater(messagess) != false){
			messages = isValidIndexWater(messages);
		}
	}
	else if(_InfoStatus == InformationStatus.info_change_information_contract){
		let validInfo = validateAndExtractInfo(messages, _InfoStatus);
		//console.log(validInfo);
		if (validInfo != false){
			if(validInfo.customerID  && validInfo.address){
				validInfo = isValidCustomerID(validInfo.customerID) + ", " + isValidAddress(validInfo.address);
			}
			else if(validInfo.customerID){
				validInfo = isValidCustomerID(validInfo.customerID);
			}
			else if(validInfo.address){
				validInfo = isValidAddress(validInfo.address);
			}
			messages = validInfo;
		}
	}
	console.log(messages);
	var chat_ai = {
		url: "http://lpnserver.net:51087/chat/url?m=ft:gpt-3.5-turbo-0613:personal::8pbzkFMI&k=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&c=" + messages,
		method: "GET",
		timeout: 5000
	};

	$.ajax(chat_ai).done(function(response) {
		console.log(response);
		let resp = response;
		resp = resp.replace("HÀNH_ĐỘNG", "action");
		resp = resp.replace("PHÂN_LOẠI", "category");
		resp = resp.replace("SỐ_ĐIỆN_THOẠI", "phone_number");
		resp = resp.replace("MÃ_KHÁCH_HÀNG", "user_id");
		resp = resp.replace("TÊN_KHÁCH_HÀNG", "user_name");
		resp = resp.replace("ĐỊA_CHỈ", "address");
		resp = resp.replace("THÁNG", "month");
		resp = resp.replace("NĂM", "year");
		resp = resp.replace("MÃ_ĐỒNG_HỒ", "number_id");
		resp = resp.replace("CHỈ_SỐ_NƯỚC", "number_value");
		let json_data = JSON.parse(resp);

		if (json_data["action"] != "null") {
			_action = json_data["action"];
			ObjContext["action"] = json_data["action"];
		}
		if (json_data["category"] != "null") {
			_category = json_data["category"];
			ObjContext["category"] = json_data["category"];
		}
		if (json_data["phone_number"] != "null") {
			_phone_number = json_data["phone_number"];
			ObjContext["phone_number"] = json_data["phone_number"];
		}
		if (json_data["user_id"] != "null"){
			_user_id = json_data["user_id"];
			ObjContext["user_id"] = json_data["user_id"];
		}
		if (json_data["user_name"] != "null") {
			_user_name = json_data["user_name"];
			ObjContext["user_name"] =json_data["user_name"];
		}
		if (json_data["address"] != "null") {
			_address = json_data["address"];
			ObjContext["address"] = json_data["address"];
		}
		if (json_data["device_id"] != "null") {
			_device_id = json_data["device_id"];
			ObjContext["device_id"] = json_data["device_id"];
		}
		if (json_data["index_value"] != "null") {
			_index_value = json_data["index_value"];
			ObjContext["index_value"] = json_data["index_value"];
		}
		if (json_data["month"] != "null") {
			_month = json_data["month"];
			ObjContext["month"]=json_data["month"];
		}
		if (json_data["year"] != "null"){ 
			_year = json_data["year"];
			ObjContext["year"] = json_data["year"];
		}

		let _ActionStatus = ActionStatus.idle;
		if (_action == "Xin chào") _ActionStatus = ActionStatus.greeting;
		else if (_action == "Phản ánh về chất lượng nước") _ActionStatus = ActionStatus.reflect_water_quality;
		else if (_action == "Phản ánh về tình trạng cấp nước") _ActionStatus = ActionStatus.reflect_water_supply;
		else if (_action == "Yêu cầu sửa chữa đồng hồ") _ActionStatus = ActionStatus.request_watch_repair;
		else if (_action == "Yêu cầu di dời,nâng hạ,bảo vệ đồng hồ" || _action == "Yêu cầu di dời,nâng hạ,bảo vệ đồng hồ nước") _ActionStatus = ActionStatus.request_watch_move_move_lift_secure;
		else if (_action == "Yêu cầu sửa chữa đường ống") _ActionStatus = ActionStatus.request_pipe_repair;
		else if (_action == "Yêu cầu kiểm tra giải thích chỉ số,đồng hồ") _ActionStatus = ActionStatus.request_IndexWatch_check_explain;
		else if (_action == "Yêu cầu sửa chữa van") _ActionStatus = ActionStatus.request_valve_repair;
		else if (_action == "Yêu cầu hoàn trả mặt bằng") _ActionStatus = ActionStatus.request_area_refund;
		else if (_action == "Hướng dẫn về các hình thức thanh toán") _ActionStatus = ActionStatus.instruction_payment_methods;
		else if (_action == "Yêu cầu liên quan đến hóa đơn" || _action == "Yêu cầu liên quan đến hoá đơn" ) _ActionStatus = ActionStatus.request_invoices;
		else if (_action == "Hướng dẫn báo chỉ số nước") _ActionStatus = ActionStatus.instruction_IndexWater_report;
		else if (_action == "Hướng dẫn nhập dãy chỉ số nước") _ActionStatus = ActionStatus.instruction_IndexWater_input;
		else if (_action == "Giải thích kỳ hoá đơn chỉ số nước" || _action == "Giải thích kỳ hoá đơn hoá đơn chỉ số nước") _ActionStatus = ActionStatus.explain_bill_period;
		else if (_action == "Yêu cầu ngày ghi chỉ số nước") _ActionStatus = ActionStatus.request_IndexWater_date;
		else if (_action == "Giải thích tạm tính") _ActionStatus = ActionStatus.explain_temporary_calculate;
		else if (_action == "Tìm hiểu về giá nước") _ActionStatus = ActionStatus.research_water_price;
		else if (_action == "Giải thích về giá nước kinh doanh" || _action == "Tìm hiểu về giá nước kinh doanh") _ActionStatus = ActionStatus.explain_business_water_price;
		else if (_action == "Tìm hiểu về thuế nước") _ActionStatus = ActionStatus.research_tax_water;
		else if (_action == "Tìm hiểu về dịch vụ thoát nước") _ActionStatus = ActionStatus.research_service_drainage;
		else if (_action == "Tìm hiểu về phí tài nguyên môi trường") _ActionStatus = ActionStatus.research_environmental_fee;
		else if (_action == "Đăng ký thủ tục lắp đồng hồ mới") _ActionStatus = ActionStatus.request_instruction_NewWatch_install;
		else if (_action == "Giải thích lắp thêm đồng hồ mới") _ActionStatus = ActionStatus.explain_NewWatch_install;
		else if (_action == "Giải thích về chi phí lắp thêm đồng hồ") _ActionStatus = ActionStatus.explain_NewWatch_install_fee;
		else if (_action == "Thay đổi thông tin trên hợp đồng cấp nước") _ActionStatus = ActionStatus.change_information_contract;
		else if (_action == "Cung cấp thông tin khách hàng") _ActionStatus = ActionStatus.provide_customer_information;
		else if (_action == "Quên thông tin cá nhân") _ActionStatus = ActionStatus.forget_personal_information;
		else if(_action == "Trao đổi thông tin") _ActionStatus = ActionStatus.discuss_information;

		
		result = "";
		console.log("Check action: " + _ActionStatus);

		switch (_ActionStatus) {
			case ActionStatus.idle:
				break;
			case ActionStatus.greeting:
				result = "Xin chào, BWACO có thể giúp gì cho anh/chị ạ?"
				_PrevActionStatus = ActionStatus.greeting;
				break;
			case ActionStatus.reflect_water_quality:
				if(_category == "Nước đục" || _category == "Nước có mùi")
				{
					result = "Vui lòng cho tôi xin mã khách hàng";
					_InfoStatus = InformationStatus.info_reflect;
				}
				else if (_category == "Nước có bọt trắng")
				{
					result = "Đây chỉ là hiện tượng bọt khí lọt vào đường ống, không ảnh hưởng đến chất lượng nước, anh/chị yên tâm ạ. Xin cảm ơn!";
				}
				_PrevActionStatus = ActionStatus.reflect_water_quality;
				break;
			case ActionStatus.reflect_water_supply:
				if(_category == "Không có nước" || _category == "Nước yếu")
				{
					result = "Vui lòng cho tôi xin mã khách hàng";
					_InfoStatus = InformationStatus.info_reflect;
				}
				break;
			case ActionStatus.request_watch_repair:
				result = "Vui lòng cho tôi xin mã khách hàng";
				_InfoStatus = InformationStatus.info_request_watch_repair;
				break;
			case ActionStatus.request_watch_move_move_lift_secure:
				result = "Vui lòng cho tôi xin mã khách hàng";
				_InfoStatus = InformationStatus.info_request_watch_move_move_lift_secure;
				break;
			case ActionStatus.request_pipe_repair:
				result = "Vui lòng cho tôi xin mã khách hàng";
				_InfoStatus = InformationStatus.info_request_pipe_repair;
				break;
			case ActionStatus.request_IndexWatch_check_explain:
				result = "Vui lòng cho tôi xin mã khách hàng";
				_InfoStatus = InformationStatus.info_request_IndexWatch_check_explain;
				break;
			case ActionStatus.request_valve_repair:
				result = "Vui lòng cho tôi xin mã khách hàng";
				_InfoStatus = InformationStatus.info_request_valve_repair;
				break;
			case ActionStatus.request_area_refund:
				result = "Vui lòng cho tôi xin mã khách hàng";
				_InfoStatus = InformationStatus.info_request_area_refund;
				break;
			case ActionStatus.instruction_payment_methods:
				result = "Quý khách hàng có thể thanh toán thông qua: các ngân hàng (danh sách 10 ngân hàng đăng ký nhờ thu tiền nước: Vietcombank, BIDV, Viettinbank, Sacombank, Agribank, VIB, Mbank, ACB, MSB, Abbank...), " +
					"các điểm thu hộ, các kênh trung gian, ví điện tử(các ví điện tử có thể thanh toán tiền nước như: Momo, Zalopay,Payoo, Vnpay, Viettel...)." +
					" Để biết thêm chi tiết vui lòng truy cập vào website của Công ty CP cấp nước Bà Rịa Vũng Tàu: http://www.bwaco.com.vn. Xin chân thành cảm ơn!";
				_PrevActionStatus = ActionStatus.instruction_payment_methods;
				break;
			case ActionStatus.request_invoices:
				if (ObjContext["user_id"] == ""){
					result = "Vui lòng cho tôi xin mã khách hàng";
					_InfoStatus = InformationStatus.info_request_invoices;
				}
				else{
					_InfoStatus = InformationStatus.idle;
					if (ObjContext["month"] == "") _month = String(_date.getMonth() + 1);
					if (ObjContext["year"] == "") _year = String(_date.getFullYear());
					// if (_month == "") _month = String(_date.getMonth() + 1);
					// if (_year == "") _year = String(_date.getFullYear());
					console.log("Check month: " +_month);

					if (ObjContext["month"] == "-1" || _month == "-1") {
						let cur_month = _date.getMonth() + 1;
						let cur_year = _date.getFullYear();
						if (cur_month == 1) {
							cur_month = 12;
							cur_year = cur_year - 1;
						} else {
							cur_month = cur_month - 1;
						}
						_month = String(cur_month);
						_year = String(cur_year);
					}
					if ((parseInt(_month) > (_date.getMonth() + 1)) && ((_year == "") || (parseInt(_year) >= _date.getFullYear()))) {
						_year = String(_date.getFullYear() - 1);
					}
					console.log("Check month: " +_month);
					var water_info = {
						url: "http://lpnserver.net:51087/bwaco?id=" + _user_id + "&m=" + _month + "&y=" + _year,
						method: "GET",
						timeout: 5000,
						async: false
					}
					$.ajax(water_info).done(function(res) {
						let len = res.length;
						result = "Hiện tại anh/chị có " + len + " hoá đơn tiền nước, chi tiết như sau:\n\n";
						res.forEach(element => {
							result += "(ID-" + element["idkh"] + ") Tên Khách Hàng: " + element["tenKhachHang"] + ", Mã KH: " + element["maKhachHang"] + "\n\n";
							result += "* Hoá đơn nước tháng " + String(element["thang"]) + " năm " + String(element["nam"]) + "\n\n";
							result += "* Chỉ số đầu: " + String(element["chiSoDau"]) + ", chỉ số cuối: " + String(element["chiSoCuoi"]) + ", tổng khối lượng: " + String(element["khoiluong"]) + "\n\n";
							result += "* Tổng tiền: " + element["tongTien"] + "đ\n\n";
							if (element["hetNo"] == true) {
								result += "* Tình trạng hoá đơn: ĐÃ THANH TOÁN";
							} else {
								result += "* Tình trạng hoá đơn: CHƯA THANH TOÁN";
							}
						});
					});
				}
				
				break;
			case ActionStatus.instruction_IndexWater_report:	
				result = "Vui lòng cho tôi xin mã khách hàng";
				_InfoStatus = InformationStatus.info_instruction_IndexWater_report;
				break;
			case ActionStatus.instruction_IndexWater_input:
				result = "Anh/Chị vui lòng nhập dãy số màu đen trên mặt đồng hồ nước. Xin cảm ơn!";
				_InfoStatus = InformationStatus.done_info_instruction_IndexWater_report_input;
				break;
			case ActionStatus.explain_bill_period:
				result = "Cảm ơn anh, chị đã gọi điện tới tổng đài, kỳ hóa đơn được tính từ ngày ghi chỉ số nước của tháng này tới ngày ghi chỉ số nước của tháng sau ạ.";
				break;
			case ActionStatus.request_IndexWater_date:
				result = "Vui lòng cho tôi xin mã khách hàng";
				_InfoStatus = InformationStatus.info_request_IndexWater_date;
				break;
			case ActionStatus.explain_temporary_calculate:
				result = "Dạ. Khi đến ngày ghi chỉ số nước, nếu nhân viên không tiếp cận được đồng hồ nước do nhà đóng cửa, nhà có trẻ nhỏ, người lớn tuổi không cung cấp được chỉ số nước thì Công ty cấp nước Bà Rịa vũng tàu sẽ tạm tính chi phí sử dụng nước bằng trung bình 3 kỳ gần nhất.";
				break;
			case ActionStatus.research_water_price:
				result = "Dạ. Trong năm 2024 định mức giá nước sinh hoạt gia đình 10m3 đầu là 9.400 đồng, từ 10-20m3 là 12.500 đồng, trên 20m3 là: 13.500 đồng.Hộ có kinh doanh hoặc Công ty là 20.200 đồng. Các giá trên chưa bao gồm thuế và phí dịch vụ thoát nước. Để biết thêm chi tiết quý khách vui lòng truy cập website: http://www.bwaco.com.vn, Xin chân thành cảm ơn!";
				break;
			case ActionStatus.explain_business_water_price:
				result = " Dạ, theo thông tư 728/QĐ-TCT-KDDVKH thì đối tượng sử dụng nước có buôn bán, kinh doanh dịch vụ sẽ được điều chỉnh biểu giá nước kinh doanh.";
				break;
			case ActionStatus.research_tax_water:
				result = "Dạ thuế GTGT tiền nước là 5% ạ.";
				break;
			case ActionStatus.research_service_drainage:
				result = "Dạ, đây là khoản thu của UBND Tỉnh nhằm bù đắp một phần chi phí thường xuyên và không thường xuyên để xây dựng, bảo dưỡng môi trường và hệ thống thoát nước. UBND tỉnh Br-VT  ban hành trong quyết định số: 17/2022/QĐ-UBND ngày 22/09/2022 về việc ban hành giá dịch vụ thoát nước trên địa bàn thành phố Vũng tàu. Công ty CP cấp nước BR-VT là đơn vị thu hộ, để biết thêm chi tiết quý khách vui lòng truy cập website: http://www.bwaco.com.vn. Xin chân thành cảm ơn!";
				break;
			case ActionStatus.research_environmental_fee:
				result = "Dạ, đây là khoản thu của UBND Tỉnh nhằm bù đắp một phần chi phí thường xuyên và không thường xuyên để xây dựng, bảo dưỡng môi trường và hệ thống thoát nước. UBND tỉnh Br-VT  ban hành trong quyết định số: 17/2022/QĐ-UBND ngày 22/09/2022 về việc ban hành giá dịch vụ thoát nước trên địa bàn thành phố Vũng tàu. Công ty CP cấp nước BR-VT là đơn vị thu hộ, để biết thêm chi tiết quý khách vui lòng truy cập website: http://www.bwaco.com.vn. Xin chân thành cảm ơn!";
				break;
			case ActionStatus.request_instruction_NewWatch_install:
				result = "Dạ, hồ sơ lắp mới bao gồm: bản photo Giấy chủ quyền nhà/đất, căn cước công dân của chủ hộ. Anh/chị vui lòng cung cấp địa chỉ lắp đặt đồng hồ, tên chủ hộ, số điện thoại ạ.";
				_InfoStatus = InformationStatus.info_request_instruction_NewWatch_install;
				break;
			case ActionStatus.explain_NewWatch_install:
				result = "Dạ. Theo quy định một bất động sản chỉ được gắn một đồng hồ nước. Trường hợp xây căn nhà thứ 2 trên cùng một thửa đất nếu lắp thêm đồng hồ khách hàng sẽ tự trả chi phí phát sinh ạ.";
				break;
			case ActionStatus.explain_NewWatch_install_fee:
				result = "Nếu giấy tờ nhà đất hợp lệ, BWACO sẽ lắp miễn phí 1 đồng hồ dưới 10m ống. Các trường hợp tính phí khi lắp đồng hồ mới sẽ căn cứ vào khảo sát thự tế và chiết tính cụ thể ạ.";
				break;
			case ActionStatus.change_information_contract:
				if(ask_more == 0){
					result = "Dạ Anh/chị vui lòng cung cấp mã khách hàng hoặc địa chỉ của ĐH nước cần thay đổi thông tin.";
					_InfoStatus = InformationStatus.info_change_information_contract;
				}
				else{
					result = "Anh/chị vui lòng cung cấp số điện thoại liên hệ";
					_InfoStatus = InformationStatus.done_info_change_information_contract;
				}
				
				break;
			case ActionStatus.provide_customer_information:
				if (_InfoStatus == InformationStatus.done_info_reflect){
					result = "Bwaco xin ghi nhận thông tin: Phản ánh chất lượng/tình trạng nước. Bạn vui lòng đợi bộ phận phụ trách liên hệ lại trong thời gian sớm nhất có thể. Xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_InfoStatus == InformationStatus.done_info_request_watch_repair){
					result = "Bwaco xin ghi nhận thông tin: Sửa chữa đồng hồ nước. Bạn vui lòng đợi bộ phận phụ trách liên hệ lại trong thời gian sớm nhất có thể. Xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_InfoStatus == InformationStatus.done_info_request_watch_move_move_lift_secure){
					result = "Bwaco xin ghi nhận thông tin: Di dời đồng hồ nước. Bạn vui lòng đợi bộ phận phụ trách liên hệ lại trong thời gian 1 tuần làm việc. Xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_InfoStatus == InformationStatus.done_info_request_pipe_repair){
					result = "Bwaco xin ghi nhận thông tin: Sửa chữa đường ống nước. Bạn vui lòng đợi bộ phận phụ trách liên hệ lại trong thời gian sớm nhất có thể. Xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_InfoStatus == InformationStatus.done_info_request_IndexWatch_check_explain){
					result = "Bwaco xin ghi nhận thông tin: Giải thích chỉ số/đồng hồ nước. Bạn vui lòng đợi bộ phận phụ trách liên hệ lại trong thời gian sớm nhất có thể. Xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_InfoStatus == InformationStatus.done_info_request_valve_repair){
					result = "Bwaco xin ghi nhận thông tin: Sửa chữa van ống nước. Bạn vui lòng đợi bộ phận phụ trách liên hệ lại trong thời gian sớm nhất có thể. Xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_InfoStatus == InformationStatus.done_info_request_area_refund){
					result = "Dạ phần hoàn trả mặt bằng do bộ phận Trám vá riêng phụ trách, do lượng công việc khá nhiều nên chưa xuống hoàn trả mặt bằng kịp. Rất xin lỗi anh/chị vì sự bất tiện này. Thông tin của anh/chị đã được chuyển đến bộ phận Trám vá. Sẽ có nhân viên của BWACO hỗ trợ anh/chị trong thời gian sớm nhất có thể. Mong anh/chị thông cảm, xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();

				}
				else if (_InfoStatus == InformationStatus.done_info_instruction_IndexWater_report_input){
					result = "Chỉ số của nhà mình đã được ghi nhận, cảm ơn anh/chị!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_InfoStatus == InformationStatus.done_info_change_information_contract){
					result = "Anh/chị vui lòng chuẩn bị hồ sơ đổi tên trên hợp đồng cấp nước gồm: bản photo Giấy tờ nhà đất đã đứng tên Anh/chị, CCCD của anh/chị. Yêu cầu thay đổi thông tin trên HĐ cấp nước của Anh/chị đã được hệ thống ghi nhận, Anh/chị vui lòng đợi bộ phận chuyên trách liên hệ lại sau. Xin cảm ơn! ";
					InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_InfoStatus == InformationStatus.info_reflect){
					if(ask_more == 0){
						if(checkDB_CustomerID(_user_id, myList)){
							//_InfoStatus = InformationStatus.done_info_reflect;
							getCheckCustomer(_user_id);
							clearForgetStatus();
							result += "Vui lòng cho tôi xin số điện thoại của bạn để liên hệ.";
						}
						else{
							result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
							clearObjContext();
						}
					}
					else if(ask_more == 1){
						result += "Nhà mình dùng nước trực tiếp hay bơm lên bồn ạ?";
					}
					
				}
				else if(_InfoStatus == InformationStatus.info_request_watch_repair){
					if(checkDB_CustomerID(_user_id, myList)){
						_InfoStatus = InformationStatus.done_info_request_watch_repair;
						getCheckCustomer(_user_id);
						clearForgetStatus();
						result += "Vui lòng cho tôi xin số điện thoại của bạn để liên hệ.";
					}
					else{
						result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
						clearObjContext();
					}
				}
				else if(_InfoStatus == InformationStatus.info_request_watch_move_move_lift_secure){
					if(ask_more == 0){
						if(checkDB_CustomerID(_user_id, myList)){
							//_InfoStatus = InformationStatus.done_info_request_watch_move_move_lift_secure;
							getCheckCustomer(_user_id);
							clearForgetStatus();
							result += "Vui lòng cho tôi xin số điện thoại của bạn để liên hệ.";
						}
						else{
							result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
							clearObjContext();
						}
					}
					else if(ask_more == 1){
						result += "Anh/chị muốn dời đồng hồ từ trong ra ngoài, hay từ ngoài vào trong ạ?";
					}
				}
				else if(_InfoStatus == InformationStatus.info_request_IndexWatch_check_explain){
					if(ask_more == 0){
						if(checkDB_CustomerID(_user_id, myList)){
							//_InfoStatus = InformationStatus.done_info_request_IndexWatch_check_explain;
							getCheckCustomer(_user_id);
							clearForgetStatus();
							result += "Vui lòng cho tôi xin số điện thoại của bạn để liên hệ.";
						}
						else{
							result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
							clearObjContext();
						}
					}
					else if(ask_more == 1){
						_InfoStatus = InformationStatus.done_info_request_IndexWatch_check_explain;
						result = "Anh/chị vui lòng kiểm tra sơ bộ hệ thống nước phía sau đồng hồ của nhà mình ạ.";
					}
					
				}
				else if(_InfoStatus == InformationStatus.info_request_pipe_repair){
					if(checkDB_CustomerID(_user_id, myList)){
						_InfoStatus = InformationStatus.done_info_request_pipe_repair;
						getCheckCustomer(_user_id);
						clearForgetStatus();
						result += "Vui lòng cho tôi xin số điện thoại của bạn để liên hệ.";
					}
					else{
						result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
						clearObjContext();
					}
				}
				else if(_InfoStatus == InformationStatus.info_request_valve_repair){
					if(checkDB_CustomerID(_user_id, myList)){
						_InfoStatus = InformationStatus.done_info_request_valve_repair;
						getCheckCustomer(_user_id);
						clearForgetStatus();
						result += "Vui lòng cho tôi xin số điện thoại của bạn để liên hệ.";
					}
					else{
						result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
						clearObjContext();
					}
				}
				else if(_InfoStatus == InformationStatus.info_request_area_refund){
					if(checkDB_CustomerID(_user_id, myList)){
						_InfoStatus = InformationStatus.done_info_request_area_refund;
						getCheckCustomer(_user_id);
						clearForgetStatus();
						result += "Vui lòng cho tôi xin số điện thoại của bạn để liên hệ.";
					}
					else{
						result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
						clearObjContext();
					}
				}
				else if (_InfoStatus == InformationStatus.info_request_invoices){
					if(checkDB_CustomerID(_user_id, myList)){
						_InfoStatus = InformationStatus.idle;
						if (ObjContext["month"] == "") _month = String(_date.getMonth() + 1);
						if (ObjContext["year"] == "") _year = String(_date.getFullYear());
						

						if (ObjContext["month"] == "-1" || _month == "-1") {
							let cur_month = _date.getMonth() + 1;
							let cur_year = _date.getFullYear();
							if (cur_month == 1) {
								cur_month = 12;
								cur_year = cur_year - 1;
							} else {
								cur_month = cur_month - 1;
							}
							_month = String(cur_month);
							_year = String(cur_year);
						}
						if ((parseInt(_month) > (_date.getMonth() + 1)) && ((_year == "") || (parseInt(_year) >= _date.getFullYear()))) {
							_year = String(_date.getFullYear() - 1);
						}
						var water_info = {
							url: "http://lpnserver.net:51087/bwaco?id=" + _user_id + "&m=" + _month + "&y=" + _year,
							method: "GET",
							timeout: 5000,
							async: false
						}
						$.ajax(water_info).done(function(res) {
							let len = res.length;
							result = "Hiện tại anh/chị có " + len + " hoá đơn tiền nước, chi tiết như sau:\n\n";
							res.forEach(element => {
								result += "(ID-" + element["idkh"] + ") Tên Khách Hàng: " + element["tenKhachHang"] + ", Mã KH: " + element["maKhachHang"] + "\n\n";
								result += "* Hoá đơn nước tháng " + String(element["thang"]) + " năm " + String(element["nam"]) + "\n\n";
								result += "* Chỉ số đầu: " + String(element["chiSoDau"]) + ", chỉ số cuối: " + String(element["chiSoCuoi"]) + ", tổng khối lượng: " + String(element["khoiluong"]) + "\n\n";
								result += "* Tổng tiền: " + element["tongTien"] + "đ\n\n";
								if (element["hetNo"] == true) {
									result += "* Tình trạng hoá đơn: ĐÃ THANH TOÁN";
								} else {
									result += "* Tình trạng hoá đơn: CHƯA THANH TOÁN";
								}
							});
						});
					}
					else {
						result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
						ObjContext["user_id"] = "";
					}
				}
				else if(_InfoStatus == InformationStatus.info_instruction_IndexWater_report){
					if(checkDB_CustomerID(_user_id, myList)){
						_InfoStatus = InformationStatus.done_info_instruction_IndexWater_report_input;
						getCheckCustomer(_user_id);
						clearForgetStatus();
						result += " Anh/chị nhắn giúp dãy số trên mặt đồng hồ nước và hình ảnh chụp mặt đồng hồ. Hệ thống sẽ kiểm tra và nhập chỉ số cho nhà mình.";
					}
					else{
						result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
						clearObjContext();
					}
				}
				else if(_InfoStatus == InformationStatus.info_request_IndexWater_date){
					if(checkDB_CustomerID(_user_id, myList)){
						_InfoStatus = InformationStatus.idle;
						getCheckCustomer(_user_id);
						clearForgetStatus();
						result += " Ngày ghi chỉ số của anh/chị là....";
					}
					else{
						result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
						clearObjContext();
					}
				}
				else if(_InfoStatus == InformationStatus.info_request_instruction_NewWatch_install){
					//_InfoStatus = InformationStatus.idle;
					result += "Vâng, Tên Khách Hàng: " + _user_name + ", Số điện thoại: " + _phone_number + ", Địa chỉ: " + _address +".\n";
					result += "Anh/chị đã xây nhà rồi hay đất trống ạ?";
				}
				else if(_InfoStatus == InformationStatus.info_change_information_contract){
					if(ask_more == 0){
						if(checkDB_CustomerID(_user_id, myList)){
						//_InfoStatus = InformationStatus.idle;
							clearForgetStatus();
							result += "Vâng, Mã Khách Hàng: " + _user_id + ", Địa chỉ: " + _address +".";
							result += "\nAnh/chị muốn thay đổi thông tin gì trên hợp đồng cấp nước ạ?";
							ask_more = 1;
						}
						else{
							result += "Mã khách hàng không hợp lệ, anh/chị vui lòng kiểm tra lại";
							clearObjContext();
						}
					}
					
				}
				_PrevActionStatus = ActionStatus.provide_customer_information;
				break;
			case ActionStatus.forget_personal_information:
				if((_category == "Quên mã khách hàng" || _category == "Quên thông tin chung") && _ForgetStatus == ForgetInformationStatus.info_forget_user_id){
					_ForgetStatus = ForgetInformationStatus.info_forget_user_name_address;
					result += "Vui lòng cho tôi xin họ tên đồng hồ nước hoặc địa chỉ của đồng hồ nước.";
				}
				else if((_category == "Quên tên khách hàng" || _category == "Quên địa chỉ" || _category == "Quên thông tin chung") && _ForgetStatus == ForgetInformationStatus.info_forget_user_name_address){
					_ForgetStatus = ForgetInformationStatus.info_forget_watch_id;
					result += "Vui lòng cho tôi xin mã đồng hồ (Mã đồng hồ được in trên viền nhựa bao xung quanh mặt đồng hồ). ";
				}
				else if((_category == "Quên mã đồng hồ" || _category == "Quên thông tin chung") && _ForgetStatus == ForgetInformationStatus.info_forget_watch_id){
					_ForgetStatus = ForgetInformationStatus.info_forget_user_id;
					result += "Quý khách vui lòng gọi trực tiếp đến tổng đài để nhận được tư vấn."
				}
				break;
			case ActionStatus.discuss_information:
				if(_PrevActionStatus == ActionStatus.provide_customer_information && _InfoStatus == InformationStatus.info_reflect){
					_InfoStatus = InformationStatus.done_info_reflect;
					result = "Tình trạng nước đục xảy ra lâu chưa ạ?";
				}
				else if(_PrevActionStatus == ActionStatus.provide_customer_information && _InfoStatus == InformationStatus.done_info_reflect){
					result = "Bwaco xin ghi nhận thông tin: Phản ánh chất lượng/tình trạng nước. Bạn vui lòng đợi bộ phận phụ trách liên hệ lại trong thời gian sớm nhất có thể. Xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if (_PrevActionStatus == ActionStatus.provide_customer_information && _InfoStatus == InformationStatus.info_request_watch_move_move_lift_secure){
					if(ask_more == 1){
						result = "Dạ nếu chỉ dời từ trong ra ngoài, hoặc ngược lại sẽ không mất phí. Trường hợp từ phải qua trái hoặc từ trái qua phải (phát sinh điểm khởi thủy) mới mất phí ạ. Nếu phát sinh chi phí nhân viên BWACO sẽ lên chiết tính báo trước với Anh/chị, nhà mình đồng ý mới làm.\nAnh/chị cần dời bao xa ạ?";
						ask_more = 2;
					}
					else if (ask_more == 2){
						_InfoStatus = InformationStatus.done_info_request_watch_move_move_lift_secure;
						result = "Dạ Anh/chị muốn nhân viên xuống dời đồng hồ vào ngày nào ạ?"
					}
				}
				else if(_PrevActionStatus == ActionStatus.provide_customer_information && _InfoStatus == InformationStatus.done_info_request_watch_move_move_lift_secure){
					result = " Dạ thời gian Anh/chị yêu cầu đã được ghi nhận và chuyển đến bộ phận kỹ thuật, BWACO sẽ cố gắng thu xếp để dời sớm cho nhà mình. Trường hợp có các sự cố đột xuất không hỗ trợ kịp mong Anh/chị thông cảm, xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_PrevActionStatus == ActionStatus.provide_customer_information && _InfoStatus == InformationStatus.done_info_request_IndexWatch_check_explain){
					result = "Thông tin của anh/chị đã được ghi nhận. Sẽ có nhân viên của BWACO liên hệ với anh/chị trong thời gian sớm nhất có thể. Trong thời gian đợi nhân viên hỗ trợ anh/chị vui lòng khóa van trước đồng hồ khi không sử dụng nước. Xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_PrevActionStatus == ActionStatus.instruction_payment_methods){
					result = "Dạ chính sách của Chính phủ hiện nay là khuyến khích không dùng tiền mặt. Nhân viên của BWACO vẫn hõ trợ thu tiền mặt nếu thời điểm đi ghi gặp chủ nhà, nếu không thu tại thời điểm đó sẽ không quay lại và nhờ nhà mình chủ động thanh toán bằng các hình thức khác ạ. Rất mong nhà mình thông cảm, xin cảm ơn!";
					_InfoStatus = InformationStatus.idle;
					clearPreviousAction();
				}
				else if(_PrevActionStatus == ActionStatus.provide_customer_information && _InfoStatus == InformationStatus.info_request_instruction_NewWatch_install){
					if(ask_more == 0){
						result = "Trường hợp chưa xây nhà Anh/chị vui lòng chuẩn bị hồ sơ bao gồm: bản photo Giấy chủ quyền nhà/đất, Căn cước công dân của chủ hộ và Giấy phép xây dựng.";
						ask_more += 1;
					}
					else if(ask_more == 1) {
						result = "Dạ trường hợp đất trống phải bổ sung giấy phép xây dựng, nếu chưa có nhà mình có thể bổ sung sau ạ.\n Bwaco xin ghi nhận thông tin: Đăng ký lắp đồng hồ, sẽ có nhân viên của BWACO liên hệ với anh, chị trong thời gian tới. Xin cảm ơn!";
						clearPreviousAction();
					}
				}
				// else if (_PrevActionStatus == ActionStatus.provide_customer_information && _InfoStatus == InformationStatus.info_change_information_contract){
					
				// }
				break;
		}
		// console.log("Prev: " + _PrevActionStatus);
		console.log("Check info status: " + _InfoStatus);
		console.log("Check prev action: " + _PrevActionStatus);
		console.log("Check ask more: " + ask_more);
		let message = result;
		const htmlText = window.markdownit().render(message);
		const botMessageHtml = '<pre><div class="message left-side" id="' + CryptoJS.MD5(htmlText) + '">' + htmlText + '</div><i class="far fa-clipboard ml-1 btn btn-outline-dark" id="' + CryptoJS.MD5(htmlText) + '-copy"></i></pre>';

		chatbox.append(botMessageHtml);

		// Add event listener to the copy icon
		var copyIcon = document.getElementById(CryptoJS.MD5(htmlText) + '-copy');
		var copyText = document.getElementById(CryptoJS.MD5(htmlText));

		copyIcon.addEventListener("click", function() {
			var tempTextarea = document.createElement("textarea");
			tempTextarea.value = copyText.textContent;
			document.body.appendChild(tempTextarea);
			tempTextarea.select();
			document.execCommand("copy");
			document.body.removeChild(tempTextarea);

			// Display "Copied!" popup
			var copyPopup = document.getElementById("copy-popup");
			copyPopup.style.display = "block";
			setTimeout(function() {
			copyPopup.style.display = "none";
			}, 1000); // Display for 1 second
		});

		chatbox.animate({ scrollTop: 20000000 }, "slow");
		sendButton.val("Gửi");
		sendButton.prop("disabled", false);
	}).fail(function(jqXHR, textStatus, errorThrown) {
		sendButton.val("Error");
		let errorText = "Error: " + jqXHR.responseJSON.error.message;
		let errorMessage = '<pre><div class="message left-side  text-danger" >' + errorText + '</div></pre>';
		chatbox.append(errorMessage);
		chatbox.animate({ scrollTop: 20000000 }, "slow");
	});
}
</script>
</html>
